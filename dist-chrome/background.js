(()=>{"use strict";console.log("ðŸš€ Background script starting...");let e=[],t=!0;function s(e){if(e)try{if(e.formData){const t=e.formData,s=new URLSearchParams;for(const[e,o]of Object.entries(t))Array.isArray(o)?o.forEach(t=>s.append(e,t)):s.append(e,o);return s.toString()}if(e.raw&&e.raw.length>0){const t=e.raw[0];if(t.bytes)return new TextDecoder("utf-8").decode(t.bytes)}return}catch(e){return void console.warn("Failed to extract request body:",e)}}const o=new Map;chrome.runtime.onMessage.addListener((s,r,n)=>{switch(s.type){case"TOGGLE_INTERCEPT":t=s.data.intercepting,console.log("Intercepting toggled:",t);break;case"CLEAR_REQUESTS":o.forEach(e=>{clearTimeout(e)}),o.clear(),e=[];break;case"GET_REQUESTS":n({requests:e});break;case"SEND_REQUEST":!async function(e){const{url:t,method:s,headers:o,body:r}=e;console.log("ðŸš€ HackBar request received:",{url:t,method:s,headers:o,body:r});const n=Object.keys(o).some(e=>"user-agent"!==e.toLowerCase()&&"accept"!==e.toLowerCase()&&"accept-language"!==e.toLowerCase()&&"accept-encoding"!==e.toLowerCase()&&"connection"!==e.toLowerCase()&&"upgrade-insecure-requests"!==e.toLowerCase());if("GET"===s&&!n&&!r){console.log("ðŸ“¤ Direct navigation for GET request");try{return void await chrome.tabs.update({url:t})}catch(e){console.error("Failed to navigate:",e)}}console.log("ðŸ“¤ Creating form submission for complex request");const a=`\n    <html>\n    <head>\n      <title>HackBar Request</title>\n    </head>\n    <body>\n      <form id="hackbar-form" method="${s}" action="${t}">\n        ${Object.entries(o).map(([e,t])=>`<input type="hidden" name="header_${e}" value="${String(t).replace(/"/g,"&quot;")}">`).join("")}\n        ${r?`<input type="hidden" name="body" value="${String(r).replace(/"/g,"&quot;")}">`:""}\n      </form>\n      <script>\n        console.log('ðŸš€ Submitting HackBar form...');\n        document.getElementById('hackbar-form').submit();\n      <\/script>\n    </body>\n    </html>`,d=new Blob([a],{type:"text/html"}),u=URL.createObjectURL(d);try{const e=await chrome.tabs.create({url:u});console.log("âœ… HackBar form created in tab:",e.id),setTimeout(()=>{chrome.tabs.remove(e.id).catch(()=>{console.log("Tab already closed or not found")})},2e3)}catch(e){console.error("Failed to create HackBar form:",e)}}(s.data);break;case"REQUEST_CAPTURED":if(s.data){const t=s.data;t.tabId=r.tab?.id||null;const o=e.findIndex(e=>e.url===t.url&&e.method===t.method&&Math.abs(e.timestamp-t.timestamp)<2e3);-1===o?(e.unshift(t),console.log("âœ… New request captured:",{id:t.id,url:t.url,method:t.method,source:"webRequest"}),chrome.runtime.sendMessage({type:"REQUEST_CAPTURED",data:t}).catch(()=>{})):console.log("ðŸ”„ Duplicate request ignored:",{url:t.url,method:t.method,existingId:e[o].id,newId:t.id})}break;case"RESPONSE_CAPTURED":if(s.data){const t=s.data;console.log("Response captured from content script:",t);let r=e.findIndex(e=>e.url===t.url&&e.method===t.method);if(-1===r&&(r=e.findIndex(e=>e.url===t.url)),-1!==r){const s=e[r],n=o.get(s.id);n&&(clearTimeout(n),o.delete(s.id)),!s.status||s.status<t.status||t.status<400?(s.status=t.status,s.responseHeaders=t.headers,s.responseBody=t.body,s.responseTime=Date.now()-s.timestamp,console.log("âœ… Response processed and updated:",{url:t.url,status:t.status,responseTime:s.responseTime,previousStatus:s.status}),chrome.runtime.sendMessage({type:"REQUEST_UPDATED",data:s}).catch(()=>{})):console.log("ðŸ”„ Response update skipped (better status already exists):",{url:t.url,currentStatus:s.status,newStatus:t.status})}else console.warn("âŒ Could not find matching request for response:",{url:t.url,method:t.method,availableRequests:e.map(e=>({url:e.url,method:e.method,id:e.id,status:e.status}))})}}}),console.log("ðŸš€ Setting up webRequest listeners, isIntercepting:",t),console.log("ðŸš€ Background script is running!"),chrome.webRequest.onBeforeRequest.addListener(r=>{if(console.log("ðŸ” WebRequest triggered:",{url:r.url,method:r.method,isIntercepting:t,requestId:r.requestId,tabId:r.tabId,type:r.type}),!t)return console.log("Intercepting is disabled, skipping request"),{cancel:!1};if(r.url.startsWith("chrome-extension://")||r.url.startsWith("moz-extension://")||r.url.startsWith("edge-extension://")||r.url.includes("devtools://")||r.url.includes("ztbox")||r.url.includes("baidu.com/ztbox"))return console.log("Skipping special request:",r.url),{cancel:!1};console.log("ðŸ” Checking for duplicates:",{url:r.url,method:r.method,totalRequests:e.length});const n={id:`${r.requestId}-${Date.now()}`,url:r.url,method:r.method,headers:{},body:s(r.requestBody),timestamp:Date.now(),tabId:r.tabId||null};!function(t){const s=e.findIndex(e=>e.url===t.url&&e.method===t.method);if(-1!==s){const o=e.splice(s,1)[0];console.log("ðŸ”„ Removed duplicate request:",{url:t.url,method:t.method,oldIndex:s,removedId:o.id,newId:t.id})}e.unshift(t),console.log("âœ… Added new request to list:",{url:t.url,method:t.method,totalRequests:e.length})}(n),console.log("âœ… Request processed via webRequest:",{id:n.id,url:n.url,method:n.method,timestamp:n.timestamp,body:n.body,bodyLength:n.body?n.body.length:0,totalRequests:e.length});const a=e[0],d=setTimeout(()=>{const t=e.findIndex(e=>e.id===a.id);-1===t||e[t].status||(console.warn("â° Request timeout, marking as failed:",{id:a.id,url:a.url,method:a.method}),e[t].status=408,e[t].responseTime=3e4,chrome.runtime.sendMessage({type:"REQUEST_UPDATED",data:e[t]}).catch(()=>{})),o.delete(a.id)},3e4);return o.set(a.id,d),chrome.runtime.sendMessage({type:"REQUEST_UPDATED",data:a}).catch(e=>{console.log("Failed to send message to devtools:",e)}),{cancel:!1}},{urls:["<all_urls>"]},["requestBody"]),chrome.webRequest.onBeforeSendHeaders.addListener(s=>{if(!t)return;if(s.url.startsWith("chrome-extension://")||s.url.startsWith("moz-extension://")||s.url.startsWith("edge-extension://")||s.url.includes("devtools://")||s.url.includes("ztbox")||s.url.includes("baidu.com/ztbox"))return;const o=e.findIndex(e=>e.id.includes(s.requestId));if(-1!==o){const t={};s.requestHeaders&&s.requestHeaders.forEach(e=>{e.name&&e.value&&(t[e.name]=e.value)}),e[o].headers=t,console.log("ðŸ“‹ Request headers captured:",{url:s.url,method:s.method,headersCount:Object.keys(t).length,headers:t})}},{urls:["<all_urls>"]},["requestHeaders"]),chrome.webRequest.onHeadersReceived.addListener(s=>{if(!t)return;if(s.url.startsWith("chrome-extension://")||s.url.startsWith("moz-extension://")||s.url.startsWith("edge-extension://")||s.url.includes("devtools://")||s.url.includes("ztbox")||s.url.includes("baidu.com/ztbox"))return;let o=e.findIndex(e=>e.id.includes(s.requestId));if(-1===o&&(o=e.findIndex(e=>e.url===s.url&&e.method===s.method)),-1!==o){const t={};s.responseHeaders?.forEach(e=>{if(e.name&&e.value)try{e.value&&"string"==typeof e.value&&e.value.trim()&&(t[e.name]=e.value)}catch(t){console.warn("Invalid header value:",e.name,e.value)}}),e[o].responseHeaders=t,console.log("Response headers captured:",t)}},{urls:["<all_urls>"]},["responseHeaders"]),chrome.webRequest.onCompleted.addListener(s=>{if(!t)return;if(s.url.startsWith("chrome-extension://")||s.url.startsWith("moz-extension://")||s.url.startsWith("edge-extension://")||s.url.includes("devtools://")||s.url.includes("ztbox")||s.url.includes("baidu.com/ztbox"))return;let r=e.findIndex(e=>e.id.includes(s.requestId));if(-1===r&&(r=e.findIndex(e=>e.url===s.url&&e.method===s.method)),console.log("Looking for request completion:",{requestId:s.requestId,url:s.url,statusCode:s.statusCode,totalRequests:e.length,foundIndex:r}),-1!==r){const t=e[r],n=o.get(t.id);if(n&&(clearTimeout(n),o.delete(t.id)),!t.status||t.status<s.statusCode||s.statusCode<400){t.status=s.statusCode;const e=s.timeStamp?Math.round(s.timeStamp-t.timestamp):Date.now()-t.timestamp;t.responseTime=e,console.log("âœ… Request completed and updated:",{url:s.url,status:s.statusCode,responseTime:e,requestId:s.requestId,previousStatus:t.status,note:"Response body not available via webRequest API"})}else console.log("ðŸ”„ Request completion update skipped (better status already exists):",{url:s.url,currentStatus:t.status,newStatus:s.statusCode,requestId:s.requestId});chrome.runtime.sendMessage({type:"REQUEST_UPDATED",data:t}).catch(e=>{console.warn("Failed to send request update:",e)})}else console.warn("âŒ Could not find matching request for completion:",{requestId:s.requestId,url:s.url,availableIds:e.map(e=>e.id)})},{urls:["<all_urls>"]}),chrome.runtime.onConnect.addListener(t=>{if("devtools"===t.name)try{t.postMessage({type:"REQUESTS_LOADED",data:{requests:e}})}catch(e){console.warn("Failed to send requests to devtools:",e)}}),chrome.runtime.onStartup.addListener(()=>{console.log("HackDuck extension started")}),chrome.runtime.onInstalled.addListener(()=>{console.log("HackDuck extension installed")})})();
//# sourceMappingURL=background.js.map