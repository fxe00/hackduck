# HackDuck å‰©ä½™Pendingè¯·æ±‚ä¼˜åŒ–

## ğŸ” é—®é¢˜åˆ†æ

### å‰©ä½™Pendingè¯·æ±‚çš„åŸå› 
è™½ç„¶å¤§éƒ¨åˆ†è¯·æ±‚å·²ç»èƒ½æ­£ç¡®æ›´æ–°çŠ¶æ€ï¼Œä½†ä»æœ‰å°‘éƒ¨åˆ†è¯·æ±‚å¤„äºpendingçŠ¶æ€ï¼Œä¸»è¦åŸå› ï¼š

1. **è¯·æ±‚åŒ¹é…å¤±è´¥**ï¼šæŸäº›è¯·æ±‚çš„IDåŒ¹é…é€»è¾‘ä»ç„¶æœ‰é—®é¢˜
2. **ç½‘ç»œè¶…æ—¶**ï¼šæŸäº›è¯·æ±‚å¯èƒ½æ°¸è¿œä¸ä¼šå®Œæˆ
3. **æµè§ˆå™¨é™åˆ¶**ï¼šæŸäº›è¯·æ±‚å¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢æˆ–é™åˆ¶
4. **å¼‚æ­¥å¤„ç†**ï¼šæŸäº›è¯·æ±‚çš„å“åº”å¤„ç†å­˜åœ¨æ—¶åºé—®é¢˜

## ğŸ”§ ä¼˜åŒ–æªæ–½

### 1. æ”¹è¿›è¯·æ±‚åŒ¹é…é€»è¾‘
**åŒé‡åŒ¹é…æœºåˆ¶**ï¼š
```typescript
// ä¸»è¦åŒ¹é…ï¼šé€šè¿‡è¯·æ±‚ID
let requestIndex = interceptedRequests.findIndex(
  req => req.id.includes(details.requestId)
);

// å¤‡ç”¨åŒ¹é…ï¼šé€šè¿‡URLå’Œæ–¹æ³•
if (requestIndex === -1) {
  requestIndex = interceptedRequests.findIndex(
    req => req.url === details.url && req.method === details.method
  );
}
```

### 2. æ·»åŠ è¶…æ—¶å¤„ç†æœºåˆ¶
**30ç§’è¶…æ—¶å¤„ç†**ï¼š
```typescript
const PENDING_TIMEOUT = 30000; // 30ç§’è¶…æ—¶
const pendingTimeouts = new Map<string, NodeJS.Timeout>();

// è®¾ç½®è¶…æ—¶å¤„ç†
const timeoutId = setTimeout(() => {
  if (requestIndex !== -1 && !interceptedRequests[requestIndex].status) {
    interceptedRequests[requestIndex].status = 408; // Request Timeout
    interceptedRequests[requestIndex].responseTime = PENDING_TIMEOUT;
  }
}, PENDING_TIMEOUT);
```

### 3. è¶…æ—¶æ¸…ç†æœºåˆ¶
**è‡ªåŠ¨æ¸…ç†**ï¼š
- è¯·æ±‚å®Œæˆæ—¶è‡ªåŠ¨æ¸…é™¤è¶…æ—¶
- æ¸…ç©ºè¯·æ±‚æ—¶æ¸…é™¤æ‰€æœ‰è¶…æ—¶
- é˜²æ­¢å†…å­˜æ³„æ¼

```typescript
// æ¸…é™¤è¶…æ—¶å¤„ç†
const timeoutId = pendingTimeouts.get(request.id);
if (timeoutId) {
  clearTimeout(timeoutId);
  pendingTimeouts.delete(request.id);
}
```

## âœ… ä¼˜åŒ–åçš„æ•ˆæœ

### åŒ¹é…æˆåŠŸç‡æå‡
- âœ… **åŒé‡åŒ¹é…**ï¼šIDåŒ¹é…å¤±è´¥æ—¶ä½¿ç”¨URL+æ–¹æ³•åŒ¹é…
- âœ… **æ›´é«˜æˆåŠŸç‡**ï¼šèƒ½åŒ¹é…åˆ°æ›´å¤šè¯·æ±‚
- âœ… **å®¹é”™èƒ½åŠ›**ï¼šå¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ

### è¶…æ—¶å¤„ç†
- âœ… **è‡ªåŠ¨è¶…æ—¶**ï¼š30ç§’åè‡ªåŠ¨æ ‡è®°ä¸º408çŠ¶æ€
- âœ… **çŠ¶æ€æ›´æ–°**ï¼špendingè¯·æ±‚ä¸ä¼šæ°¸è¿œpending
- âœ… **å†…å­˜ç®¡ç†**ï¼šè‡ªåŠ¨æ¸…ç†è¶…æ—¶å¤„ç†

### è°ƒè¯•èƒ½åŠ›
- âœ… **è¯¦ç»†æ—¥å¿—**ï¼šæ˜¾ç¤ºåŒ¹é…è¿‡ç¨‹å’Œç»“æœ
- âœ… **è¶…æ—¶è­¦å‘Š**ï¼šæ˜¾ç¤ºè¶…æ—¶çš„è¯·æ±‚ä¿¡æ¯
- âœ… **çŠ¶æ€è·Ÿè¸ª**ï¼šå®Œæ•´çš„çŠ¶æ€å˜åŒ–è®°å½•

## ğŸ” è°ƒè¯•ä¿¡æ¯

### æ­£å¸¸æµç¨‹
```
1. "âœ… Request intercepted via webRequest" - è¯·æ±‚è¢«æ‹¦æˆª
2. "Looking for request completion" - æŸ¥æ‰¾è¯·æ±‚å®Œæˆ
3. "âœ… Request completed and updated" - è¯·æ±‚å®Œæˆå¹¶æ›´æ–°
```

### è¶…æ—¶å¤„ç†
```
1. "â° Request timeout, marking as failed" - è¯·æ±‚è¶…æ—¶
2. çŠ¶æ€æ›´æ–°ä¸º408 (Request Timeout)
3. å“åº”æ—¶é—´è®¾ç½®ä¸º30ç§’
```

### åŒ¹é…å¤±è´¥
```
1. "âŒ Could not find matching request for completion" - åŒ¹é…å¤±è´¥
2. æ˜¾ç¤ºå¯ç”¨çš„è¯·æ±‚IDåˆ—è¡¨
3. å°è¯•å¤‡ç”¨åŒ¹é…æ–¹æ¡ˆ
```

## ğŸš€ é¢„æœŸæ•ˆæœ

### è¯·æ±‚çŠ¶æ€è¦†ç›–
- **æ­£å¸¸è¯·æ±‚**ï¼šæ­£ç¡®æ˜¾ç¤ºå®é™…çŠ¶æ€ç 
- **è¶…æ—¶è¯·æ±‚**ï¼š30ç§’åæ˜¾ç¤º408çŠ¶æ€
- **å¤±è´¥è¯·æ±‚**ï¼šæ˜¾ç¤ºåŒ¹é…å¤±è´¥ä¿¡æ¯
- **è¦†ç›–ç‡**ï¼šæ¥è¿‘100%çš„è¯·æ±‚çŠ¶æ€æ›´æ–°

### ç”¨æˆ·ä½“éªŒ
- **å®æ—¶æ›´æ–°**ï¼šè¯·æ±‚çŠ¶æ€å®æ—¶å˜åŒ–
- **æ¸…æ™°æ˜¾ç¤º**ï¼špendingçŠ¶æ€ä¸ä¼šæ°¸è¿œå­˜åœ¨
- **è°ƒè¯•å‹å¥½**ï¼šè¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### åŒ¹é…ä¼˜å…ˆçº§
1. **ä¸»è¦åŒ¹é…**ï¼š`req.id.includes(details.requestId)`
2. **å¤‡ç”¨åŒ¹é…**ï¼š`req.url === details.url && req.method === details.method`

### è¶…æ—¶é…ç½®
- **è¶…æ—¶æ—¶é—´**ï¼š30ç§’
- **è¶…æ—¶çŠ¶æ€**ï¼š408 Request Timeout
- **æ¸…ç†æœºåˆ¶**ï¼šè‡ªåŠ¨æ¸…ç†è¶…æ—¶å¤„ç†

### å†…å­˜ç®¡ç†
- **è¶…æ—¶æ˜ å°„**ï¼š`Map<string, NodeJS.Timeout>`
- **è‡ªåŠ¨æ¸…ç†**ï¼šè¯·æ±‚å®Œæˆæ—¶æ¸…é™¤
- **æ‰¹é‡æ¸…ç†**ï¼šæ¸…ç©ºè¯·æ±‚æ—¶æ¸…é™¤æ‰€æœ‰

ç°åœ¨HackDuckåº”è¯¥èƒ½å¤„ç†å‡ ä¹æ‰€æœ‰è¯·æ±‚çŠ¶æ€ï¼ŒåŒ…æ‹¬é‚£äº›å¯èƒ½æ°¸è¿œä¸ä¼šå®Œæˆçš„è¯·æ±‚ï¼ğŸ‰
